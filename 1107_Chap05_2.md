# 웹에서 가속을 이끌어 내는 방법 2

### 도메인 분할 기법(domain sharding) 이용하기

✔ 도메인 분할 기법
- **여러 도메인을 소유**한 경우 웹 콘텐츠를 **병렬적으로 동시에 다운로드**할 수 있도록 하는 방법이다.


✔ 브라우저
- **브라우저**는 HTTP/1.1 프로토콜 하에서 동일 도메인에 순차적 다운로드 방식을 사용한다. 도메인 분할은 **달리 보면 HTTP/1.1 프로토콜 하에서 브라우저의 제약을 피하는 방식**이다.
- 브라우저는 동일 호스트명의 **동시 연결 개수를 제한**하고 있는데, 한 도메인 당 6~13 개의 TCP 연결들을 동시 생성해 여러 리소스를 한 번에 다운로드할 수 있도록 허용한다.

![image](https://user-images.githubusercontent.com/65053379/140602900-2d676889-52f1-489c-b21c-ff68263bd5e2.png)

↑ **크롬**은 서버와 6개의 연결을 생성하고 리소스를 다운로드 합니다. 

- 브라우저가 허용하는 동시 연결 개수는 **브라우저의 종류와 버전**에 따라 차이가 난다.

![image](https://user-images.githubusercontent.com/65053379/140602992-eea8b032-e314-4f4b-9214-bcf9386aedc8.png)

↑ 예를 들어 **6개의 동시 연결**을 지원하는 브라우저에서 **도메인 분할 방식을 통해 2개의 도메인을 이용하면 이론적으로는 12개의 연결이 가능**하다. 


✔ 추가 도메인 디자인 예시

**콘텐츠의 특징에 따라** 도메인을 나누어 **병렬로 동시 다운로드**한다면, **전반적인 다운로드 완료 시간이 앞당겨질 것**이다. www.feokorea.com 이라는 사이트를 운영한다고 가정할 때, 추가 도메인을 다음과 같이 디자인할 수 있다.

* www.feokorea.com : 웹 사이트 메인 페이지 및 동적 컨텐츠를 위한 도메인
* img.feokorea.com : 이미지 호출을 위한 도메인
* script.feokorea.com : 자바스크립트 파일, CSS와 같은 정적 콘텐츠를 위한 도메인
* api.feokorea.com : API 서비스를 사용하기 위한 도메인

※ 도메인 분할 기법을 이용했을 때 장점? **사이트 전체 쿠키 사이즈를 축소**할 수 있다!


✔ 개인화

최근 많은 기업의 웹 사이트는 **사이트를 한 번이라도 방문한 고객**을 붙잡기 위해 **고객의 성별, 나이, 취미 등 개인 취향에 맞도록 사이트를 구성하고 적절한 상품을 추천**하기도 한다. 
★ 이러한 개인화는 사용자가 로그인했거나 또는 로그인하지 않았더라도 **사용자 정보**를 **브라우저 쿠키**에 저장해두고 **그 사용자가 방문할 때마다 브라우저에서 보내주는 쿠키 정보를 참조**하기 때문에 가능하다. 개인화가 심화될 수록 **쿠키에는 더 많은 정보**가 저장되고 크기도 점점 커진다.

![image](https://user-images.githubusercontent.com/65053379/140603690-5abd73ec-b151-4773-ba85-87722ff322ac.png)

↑ 크롬 개발자 도구에서 확인한 쿠키 정보


✔ **도메인을 몇 개로 운용하는 것이 최적인지** 결정하는 데는 좀 더 면밀한 계획과 테스트가 필요하다.
- 하나의 웹 페이지에 포함된 리소스 개수가 얼마나 많은가에 따라 추가할 서브 도메인의 숫자를 결정해야 한다. 
- 너무 많은 도메인을 추가하면, 오히려 브라우저의 성능을 저하시킬 수 있으므로 주의해야 한다. ( 동시 다운로드 숫자 多 → **더 많은 CPU 리소스 사용** → CPU 리소스 한계 도달 시 다운로드 속도 저하)
- 결론! 최신 컴퓨터의 CPU 파워 및 네트워크 속도를 감안할 때 **리소스 숫자에 따라 도메인 수를 결정하는 것이 바람직**하다. 사용할 도메인 개수가 정해지면 그 수에 맞도록 리소스들을 균등 분할하자.

![image](https://user-images.githubusercontent.com/65053379/140603895-4a0705cd-dba4-45d7-852b-ddae539622ac.png)


✔ **리소스를 분류하는 방법**

1. 리소스 성격에 따라 분류하는 방법 : 자바스크립트, CSS, 폰트 같은 **다양한 렌더링과 이미지, 멀티미디어 리소스들을 종류별로 구분**하고 그 **수**를 파악해 도메인 별로 균등하게 분배되도록 그룹화하는 방법이다.
2. 동적으로 분류하는 방법 : 보다 정확한 분배를 위해서는 **배포 시점에 동적으로 도메인명을 결정하도록** 하는 것을 권한다. 이때 **특정 리소스에 항상 같은 도메인을 배정되도록** 해야만 캐시 적중률이 높아진다.
  - 해시 방식 : 해시 함수를 사용해 **파일명을 숫자로** 변경하고 **숫자에 따라** 도메인을 결정하는 방식. (ex

---

### 도메인 분할 기법과 HTTP/2
도메인 분할 기법이 고안된 이유는 HTTP/1.1의 가장 큰 문제점으로 지적되어 온 **Head Of Line Blocking 현상** 때문이다. **HTTP/2는 멀티플렉싱 기술**로 해결해서 도메인 분할 기법을 사용할 이유가 없지만, 예전 버전의 브라우저들은 아직 HTTP/2를 지원하지 않기 때문에 여러 개의 도메인이 필요할 수 있다.

- HTTP/2 특징 : 헤더 압축 전송, 우선순위 전송 그리고 서버 푸시 기능

✔ TCP 연결 병합

최근 사용하는 브라우저들은 HTTP/2 기능을 저해하지 않으면서 다중 도메인을 사용할 수 있는 방안을 제공한다. TCP 연결 병합은 브라우저가 **첫 번째 도메인과 맺은 TCP 연결을 나머지 도메인에 재사용하는 방식**이다.

고려해야 할 사항 
  1. 브라우저가 DNS를 확인할 때, 각 도메인은 모두 동일한 IP 주소를 반환해야 한다.
  2. 동일한 인증서를 사용해야 한다. 


※ 이 두 가지 사항만 잘 지키면, HTTP/1.1 사용자와 HTTP/2 사용자를 모두 고려한 도메인 분할 전송 환경을 구성할 수 있다.

---

### 사용자 경험 개선하기

**브라우저의 성능 지표**만 향상시킨다고 해서 실제 사용자가 느끼는 성능이 향상되는 것은 아니다. **사용자의 경험을 개선하기 위한 다른 방식의 측정 방법 및 개선 방안**이 요구된다.

### 사용자 경험 지표 바로 알기

1. **WebPageTest**의 Speed Index 지표 : **Speed Index 값**은 아직 시각적으로 완성되지 못한 면적을 계산하여 산정한다. 페이지 로딩 시간은 같더라도 Speed Index 값에 따라 시각적으로 더 빠르게 완성될 수 있다. 
2. First Contentful Paint : 눈에 띄는 컨텐츠가 처음 표현되는 시점인 첫 번째 콘텐츠가 있는 페인트
3. Largest Contentful Paint : 히어로 이미지와 같은 주요 콘텐츠가 로딩되는 시점인 가장 큰 콘텐츠가 있는 페인트 
4. Time to Interactive : 사용자와 상호 작용이 어느 정도 가능해지는 시점인 상호 작용 시간

### 사용자의 요청에 빠르게 반응하기

인간은 응답 속도가 100ms 늦어질 때 이를 인지할 수 있고, 1초가 지나면 지연으로 인식한다. 

✔ 사용자 요청에 빠르게 반응하려면 기본적으로 **서버의 응답**이 빨라야 한다.
- TTFB, Time To First Byte : 브라우저가 서버에서 응답한 첫 번째 바이트를 수신하는 기간으로 300~500ms가 이상적이다.

✔ 브라우저가 렌더링을 빠르게 시작하게 하려면 아래와 같은 최적화 기법들을 고려할 수 있다.
1. CSS와 자바스크립트 파일들의 크기를 줄인다. 
  - 공백과 주석을 제거하는 방법이 있다. 
  - 렌더링할 페이지에서 실제 사용되는 필요한 코드만 남기고 필요하지 않은 부분은 제거하는 방법
2. CSS와 자바스크립트들을 중요 리소스와 그렇지 않은 리소스로 분류한다.
3. 분류된 중요 리소스들은 빠르게 로딩시킨다. 
4. 중요하지 않은 리소스들은 나중에 로딩시킨다. 
