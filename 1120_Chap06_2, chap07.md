# 캐시 최적화

### 4. 캐시에 적합한 디렉터리 구조 구성하기

- 캐시 가능 콘텐츠를 별도의 폴더로 분리하여 관리
> static/image       
> static/css           
> static/js      

- 캐시 주기별로 분리하여 구성              
: 이 때는 같은 자바스크립트라도 캐시 주기가 다를 수 있습니다.
> /static/js/lib              
> /static/js/module/A             
> /static/js/module/B         

- 동일한 파일을 여러곳에 분산시키지 않아야 한다.               
 : 상대 경로를 사용하려고 같은 파일을 복제해 사용하는 경우를 유의 -> 동일한 파일은 한 폴더에 보관하고 관련 URL을 참조.
 
 
 ### 5. 캐시 키 올바르게 사용하기
  - `캐시키`: 서버가 원본의 복사본을 저장하고 빠르게 조회하기 위해 사용하는 키 값을 말한다.            
  > 일반적인 캐시 키 구성          
  > 호스트/패스?쿼리 스트링             
  > www.foekorea.com/kr/feo/myPic.jpg?width=200&height=100          


 #### 캐시 오염과 캐시 충돌
 - `캐시 오염`: 원본 서버에 하나의 원본 파일만 존재하는데 캐시에 복사본이 여러 개 존재하는 것
 - `캐시 충돌`: 요청 URL은 하나인데 브라우저 환경에 따라 서버에서 제공하는 응답이 달라져 결국 최초 요청한 브라우저의 응답만 캐시되는 경우
 
 #### 캐시 오염 제거
- 사용자에게 영향을 주지는 않지만 서버의 효율성에 부담
- URL에 붙은 특정 쿼리 스트링 값이 달라도 응답이 같다면 해당 캐시키에서 쿼리 스트링 무시
- 쿼리 스트링의 순서를 동일하게 정렬
- Vary 헤더를 바르게 사용

##### Vary 헤더
- 상황에 따라 서버의 응답이 달라지는 것
- Vary는 특정 HTTP 헤더 정보를 나열, 헤더 값에 따라 다른 응답을 준다는 것을 캐시 서버에 알림.

#### 캐시 충돌 방지
- 캐시 충돌은 동적 페이지를 캐시할 때 주로 발생
- ex. www.naver.com 같은 URL이지만 로그인 유무에 따라 화면이 달라짐.
- 동적 페이지에서는 캐시를 적용하지 않는다.

### 6. CDN 사용하기
- 사용자에게 가깝게 캐시하기 위해 CDN 서비스를 이용하자
- 해외 사용자가 국내 원본 서버를 통해 웹 서비스를 받으면 많은 ISP와 네트워크 홉을 거쳐야 한다.(많은 시간 지연 발생 가능)


### 7. 동적 콘텐츠 캐시
1. 동적 정보를 쿠키에 넣어 본내다.
2. Ajax 요청으로 관련 정보를 동적으로 받아온다.

#### 주의점
1. 보안에 유의
- POST 요청(개인정보)에 대한 응답은 캐시하지 않는다.
2. 캐시 서버 용량에 유의
- 과도하게 개인화된 콘텐츠 캐시는 지양한다.
- 로그인 전, 브라우저 타입, 사용자 서별에 따른 콘텐츠 등 크게 그룹화해서 사용
3. 캐시는 HTTP GET 방식에서 동작하므로 Ajax요청에 대한 응답을 캐싱하고자 할 때는 GET 방식을 사용한다.
4. 캐시 주기를 0 TTL을 사용하려면 서버에서 해당 콘텐츠에 대한 IMS 요청을 지원해야 한다.

### 8. POST 응답 캐시
- POST 요청/응답 캐시는 보안적으로 안전한 내용이라면 캐시 할 수 있다.
- 단, 캐시키에 요청 매개 변숫값이 모두 포함되어야 한다.(캐시오염, 충돌 방지)
- MD5같은 해시 알고리즘을 이용해 값을 암호화 해야한다.

#### POST 요청/응답 캐시 조건
1. 매개 변숫 값에 항상 같은 응답을 할 것
2. 개인 정보 포함 X
3. 요청 사이즈가 크지 않은 경우


### 6.5 고급 캐시 전략
#### Edge Side Include
- HTML 콘텐츠 CDN에 캐시
- 인터넷 에지에서 웹 페이지 조각을 동적으로 조립, 전달, 조합 할 수 있도록 따로 정의(ESI)
- 한 페이지 내에서 다른 페이지를 포함할 수 있고, 따로 캐시 정책을 적용 할 수 있다.
- HTTP 헤더 정보를 변수로 참조하거나, 조건문을 사용해 다른 비즈니스 로직을 적용할 수도 있고, ESI는 마크업언어로 단순해 쉽게 적용할 수 있다.
- 웹 캐시가 ESI언어를 지원해야 한다.(EX Varnish, Squid 등)
- 과도한 연산, 실시간성이 중요한 정보는 ESI에 적합하지 않다.


```html
<html>
  <head>
  <title> esi example <title>
  <link rel="stylesheet" href="style.css" type="text/css"/>
  <script type="text/javascript" src="jquery.js"></script>
  ...
</head>
<body>
  <!-- 헤더 부분 -->
  <!-- 사용자 프로필 표시 부분 -->
  <esi:include src="http://www.feokorea.com/login.html" alt=http://www.
  feokorea.com/fail_over.html
  onerror="continue"/>
  ...
</body>
</html>
```

#### 웹 스토리지
1. Local Storage
2. Session Storage

- 쿠키 대체(보안, 네트워크 대역폭 낭비 등)
- 폰트, css, JS 저장 




## 볼만한 자료
- <a href="https://sudalkim.tistory.com/11">Cache Busting 문제 해결하기(React)</a>
- <a href="https://ideveloper2.tistory.com/121">리액트 앱 배포시 cache 안남게하기</a>
- 웹 성능 최적화 기법 책 p.224 ~ p.236


## 번외
- <a href="https://han41858.tistory.com/54">어떤 웹 스토리지를 써야할까?</a>
