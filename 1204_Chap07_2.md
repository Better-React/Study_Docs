# Chap.07 CDN

## 7.4 전달 경로 최적화

> 모바일 애플리케이션의 중요성 강조, API 호출이 속도를 증가시키는 주요 해결책으로 대두됨. 전달경로 최적화는 어플 응답 속도를 빠르게 하는 기능. 빠른 길을 찾는 과정이라고 생각.

1. 라스트 마일 최적화
   > 최종 사용자 요청을 사용자와 가장 가까운 곳에 있는 에지 서버로 전송하는 일

- dns 기반 에지 선택
  : 사용자와 가장 가까운 dns 서버가 배정되도록 최적화 됨. 매우 기본적이고 안정적으로 사용된다는 장점. 사용자가 직접 특정 dns 서버 지정 사용시 의도하지 않은 에지 서버가 선택될 수 있음.

- 애니캐스트 기반 에지 선택
  : 네트워크상에서 원하는 IP 주소로 데이터를 전송하는 방식 중 하나. 1:1 전송 방식이며, 다수의 노드가 동일한 IP 주소를 가짐. 실 사용자와 가장 가까운 네트워크의 에지 서버가 선택된다는 장점(실제 물리적 거리에 따른 가까움이 아닌, ISP 계약 관계에 따른 최적 경로 결정). 서버 장애시 자동 우회하므로 가용성도 보장.

2. 프로토콜 최적화

> 사용자 기기와 원본 서버 간 웹 트래픽 가속화를 위해서 경로 최적화 + 프로토콜 최적화 병행 필요. 프로토콜 최적화는 한 번에 많은 트래픽을 보낼 수 있도록 길을 넓히는 작업.

> 가능한 많은 패킷을 한번에 보내는 것이 유리하나, 보낸다 해도 전부 다 받을 수 있는것은 아니므로 송신측은 수신측의 윈도우 사이즈(수신 가능한 데이터 크기)를 고려해 그보다 더 적은 양의 데이터를 보내고, 수신측은 윈도우 사이즈 크기를 서버에 통지함.

- TCP 최적화
  : 느린 시작 알고리즘을 사용. (송신 측이 전송 시작할 때 적은 양의 데이터부터 전송하는 것. =혼잡 윈도우)
- TLS 종료와 TCP 연결 재사용
  : HTTP 통신을 할 때 TLS handshake는 최정 사용자와 CDN 사이, CDN과 원본서버 사이에 한 번씩 발생함. TCP 연결을 바로 끊지 않고 재사용하면, 사용자 수만큼 TCP 연결할 필요 없이 에지 수만큼 TCP를 연결. 서버 자원을 아낄 수 있음.

## 7.5 기타 성능 옵션

1. CDN이 제공하는 기본 기능

- http 압축 : 텍스트파일 전송시에 매우 중요한 역할. 대부분 gzip 압축 방식을 지원. 웹 서버 설정을 통해 구현할 수 있다. 단, cdn이 제공하는 압축은 에지 서버와 브라우저 네트워크 구간에만 적용되므로 호스팅 서버와 에지 서버 사이의 네트워크 구간을 가속화 하기 위해선 서버 측에서 압축 설정 필요.
- 브라우저 캐시 : 사용자가 웹사이트에 재방문할 때 브라우저는 그간 콘텐츠가 변경되었는지 검사하고, 변경된 파일만 다운로드함. cdn 서비스를 이용하면 콘텐츠 캐시 주기를 별도로 설정함. `Cache-control`을 어떻게 처리할 것인지 옵션을 제공함. (옵션 : cdn 디폴트, 서버에서 응답한 헤더를 그대로 브라우저에 전송, cdn에 설정한 캐시 주기와 서버 응답 헤더의 캐시 주기 중 더 길게 남은값, 더 짧게 남은 값, 브라우저 캐시 사용 안함)
- Html, css, 자바스크립트 최소화 : 주석, 공백 등 제거. 
- DNS 프리페치와 프리커넥트 :
    - 소스에 직접 링크 삽입할 경우
```
<link rel="dns-prefetch" href="//image.example.com">
```
리소스를 다운로드할 도메인이 많은 경우 미리 도메인명의 IP를 찾으면 브라우저가 실제로 해당 리소스를 다운로드하는 시점에 IP 검색 시간을 줄일 수 있고, 페이지 로딩 시간을 단축할 수 있음.
이렇게 링크를 삽입하기 어려울 경우 cdn 에서 제공하는 dns프리페치 기능을 사용할 수 있음.
> Link: <http://imgage.ex.com>; rel=dns-prefetch

TCP 연결까지 미리 생성하는 프리커넥트도 사용할 수 있음

> Link: <http://image.ex.com>; rel=preconnect

2. 신기술 적용을 위한 CDN 기능

- http/2와 http/3
    - http/2 : 이미 많은 기업에서 도입해 사용중. 브라우저와 에지 서버 사이 구간엥서만 캐시할 수 있는 정적 콘텐츠를 가속하는 데 사용.
    - http/3 : http/2보다 빠르고 안전한 차세대 프로토콜. 아직 CloudFlare에서만 유일하게 지원.
- 서버푸시
: 리소스에대한 다운로드 요청을 보내지않아도 필요한 자원을 미리 전송해주는 기능.
- Ipv6 듀얼 스택
128 비트의 길이를 사용해 주소를 만들어 약 340조 개의 방대한 양의 고유 ip를 만들 수 있음. ipv4에 비해 간소화된 헤더, 자동 구성 기능 제공, 자동 네트워킹 기능, 패킷 품질 보장, 보안 기능 강화 등의 장점이 있음. 하지만 기존의 ipv4를 ipv6로 전환하는 것은 간단하지 않으므로, ipv4와 v6 모두 사용할 수 있는 듀얼 스택을 장착함.

## 읽어볼만한 글

- 3 way handshake : https://mindnet.tistory.com/entry/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%89%BD%EA%B2%8C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0-22%ED%8E%B8-TCP-3-WayHandshake-4-WayHandshake
